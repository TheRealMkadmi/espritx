{% extends 'views/layouts/contentLayoutMaster.html.twig' %}

{% block title %} Acceuil Posts {% endblock %}

{% block page_style %}
  <style>

      .hero {
          padding: 6.25rem 0px !important;
          margin: 0px !important;
      }

      .cardbox {
          border-radius: 3px;
          margin-bottom: 20px;
          padding: 0px !important;
      }


      .cardbox .cardbox-heading {
          padding: 16px;
          margin: 0;
      }

      .cardbox .btn-flat.btn-flat-icon {
          border-radius: 50%;
          font-size: 24px;
          height: 32px;
          width: 32px;
          padding: 0;
          overflow: hidden;
          color: #fff !important;
          background: #b5b6b6;

          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
      }

      .cardbox .float-right .dropdown-menu {
          position: relative;
          left: 13px !important;
      }

      .cardbox .float-right a:hover {
          background: #f4f4f4 !important;
      }

      .cardbox .float-right a.dropdown-item {
          display: block;
          width: 100%;
          padding: 4px 0px 4px 10px;
          clear: both;
          font-weight: 400;
          font-family: 'Abhaya Libre', serif;
          font-size: 14px !important;
          color: #848484;
          text-align: inherit;
          white-space: nowrap;
          background: 0 0;
          border: 0;
      }

      /* ------------------------------- */
      /* Media Section
      ---------------------------------- */
      .media {
          display: -ms-flexbox;
          display: flex;
          -ms-flex-align: start;
          align-items: flex-start;
      }

      .d-flex {
          display: -ms-flexbox !important;
          display: flex !important;
      }

      .media .mr-3 {
          margin-right: 1rem !important;
      }

      .media img {
          width: 48px !important;
          height: 48px !important;
          padding: 2px;
          border: 2px solid #f4f4f4;
      }

      .media-body {
          -ms-flex: 1;
          flex: 1;
          padding: .4rem !important;
      }

      .media-body p {
          font-family: 'Rokkitt', serif;
          font-weight: 500 !important;
          font-size: 14px;
          color: #88898a;
      }

      .media-body small span {
          font-family: 'Rokkitt', serif;
          font-size: 12px;
          color: #aaa;
          margin-right: 10px;
      }


      /* ------------------------------- */
      /* Cardbox Item
      ---------------------------------- */
      .cardbox .cardbox-item {
          position: relative;
          display: block;
      }

      .cardbox .cardbox-item img {
      }

      .img-responsive {
          display: block;
          max-width: 100%;
          height: auto;
      }

      .fw {
          width: 100% !important;
          height: auto;
      }


      /* ------------------------------- */
      /* Cardbox Base
      ---------------------------------- */
      .cardbox-base {
          border-bottom: 2px solid #f4f4f4;
      }

      .cardbox-base ul {
          margin: 10px 0px 10px 15px !important;
          padding: 10px !important;
          font-size: 0px;
          display: inline-block;
      }

      .cardbox-base li {
          list-style: none;
          margin: 0px 0px 0px -8px !important;
          padding: 0px 0px 0px 0px !important;
          display: inline-block;
      }

      .cardbox-base li a {
          margin: 0px !important;
          padding: 0px !important;
      }

      .cardbox-base li a i {
          position: relative;
          top: 4px;
          font-size: 16px;
          color: #8d8d8d;
          margin-right: 15px;
      }

      .cardbox-base li a span {
          font-family: 'Rokkitt', serif;
          font-size: 14px;
          color: #8d8d8d;
          margin-left: 20px;
          position: relative;
          top: 5px;
      }

      .cardbox-base li a em {
          font-family: 'Rokkitt', serif;
          font-size: 14px;
          color: #8d8d8d;
          position: relative;
          top: 3px;
      }

      .cardbox-base li a img {
          width: 25px;
          height: 25px;
          margin: 0px !important;
          border: 2px solid #fff;
      }


      /* ------------------------------- */
      /* Cardbox Comments
      ---------------------------------- */
      .cardbox-comments {
          padding: 10px 40px 20px 40px !important;
          font-size: 0px;
          text-align: center;
          display: inline-block;
      }

      .cardbox-comments .comment-avatar img {
          margin-top: 1px;
          margin-right: 10px;
          position: relative;
          display: inline-block;
          text-align: center;
          width: 40px;
          height: 40px;
      }

      .cardbox-comments .comment-body {
          overflow: auto;
      }

      .search {
          position: relative;
          right: -60px;
          top: -40px;
          margin-bottom: -40px;
          border: 2px solid #f4f4f4;
          width: 100%;
          overflow: hidden;
      }

      .search input[type="text"] {
          background-color: #fff;
          line-height: 10px;
          padding: 15px 60px 20px 10px;
          border: none;
          border-radius: 4px;
          width: 350px;
          font-family: 'Rokkitt', serif;
          font-size: 14px;
          color: #8d8d8d;
          height: inherit;
          font-weight: 700;
      }

      .search button {
          position: absolute;
          right: 0;
          top: 0px;
          border: none;
          background-color: transparent;
          color: #bbbbbb;
          padding: 15px 25px;
          cursor: pointer;

          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
      }

      .search button i {
          font-size: 20px;
          line-height: 30px;
          display: block;
      }


      /* ------------------------------- */
      /* Author
      ---------------------------------- */
      .author a {
          font-family: 'Rokkitt', serif;
          font-size: 16px;
          color: #00C4CF;
      }

      .author p {
          font-family: 'Rokkitt', serif;
          font-size: 16px;
          color: #8d8d8d;
      }


  </style>

  <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!------ Include the above in your HEAD tag ---------->


  <link href="https://fonts.googleapis.com/css?family=Rokkitt" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Page css files -->
  <link rel="stylesheet" href="{{ asset('css/base/pages/app-chat.css') }}">
  <link rel="stylesheet" href="{{ asset('css/base/pages/app-chat-list.css') }}">
{% endblock %}


{% block content_sidebar %}
  {% include 'views/content/apps/chat/app-chat-sidebar.html.twig' %}
{% endblock %}


{% block content %}
  <div class="alert alert-success">
    {% for message in app.flashes('info') %}
      {{ message }}
      <br>
    {% endfor %}
  </div>
  <div class="note note-warnning">
    {% for flash_message in app.session.flashBag.get('notice') %}
      <p>{{ flash_message }}</p>
    {% endfor %}
  </div>
  {% for flash_message in app.session.flashBag.get('success') %}
    <div class="note note-success">
      <p>{{ flash_message }}</p>
    </div>

  {% endfor %}

  {% for post in posts %}
    {% if post.isDeleted == 0 %}
      <section class="hero">
        <div class="container">
          <div class="row">
            <div class="col-lg-6 offset-lg-3">
              <div class="cardbox shadow-lg bg-white">
                <div class="cardbox-heading">
                  <!-- START dropdown-->
                  <div class="dropdown float-right">
                    {% if app.user == post.user %}
                      <details class="dropdown">
                        <summary role="button">
                          <a class="button"> <em class="fa fa-ellipsis-h"></em></a>
                        </summary>
                        <ul>
                          <li><a href="{{ path('editpost', {'id': post.id}) }}">Modifier</a></li>
                          <li>
                            <a href="{{ path('changedelete_post', {'id': post.id}) }}">Supprimer</a>
                          </li>
                        </ul>
                      </details>
                      {% if  not post.isValid %}
                        <p style="size: 8px" class="btn-warning "><i class="fa fa-times">Votre publication en attente de
                            verification par notre admin</i></p>
                      {% endif %}
                    {% endif %}
                  </div><!--/ dropdown -->
                  <div class="media m-0">
                    <div class="d-flex mr-3">
                      <a href=""><img class="img-fluid rounded-circle"
                                      src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/4.jpg"
                                      alt="User"></a>
                    </div>
                    <div class="media-body">
                      <p class="m-0">{{ post.user.firstName }}</p>
                      <small><span><i class="icon ion-md-pin"></i> {{ post.title }}</span></small>
                      <small><span><i
                              class="icon ion-md-time"></i> {{ post.createdAt | date('Y-M-D') }} à {{ post.createdAt | date('h:m') }} </span></small>
                    </div>
                  </div><!--/ media -->
                </div><!--/ cardbox-heading -->

                <div class="cardbox-item">
                  <div class="cardbox-item">
                    {{ post.content }}
                    <img class="img-fluid"
                         src="{{ asset('uploads/brochures/' ~ post.image) }}"
                         alt="Image">
                  </div>
                </div><!--/ cardbox-item -->
                <div class="cardbox-base">
                  <ul class="float-right">
                    <li><a><i class="fa fa-comments"></i></a></li>
                    <li><a href="{{ path('singlepost',{'id':post.id}) }}"><em
                            class="mr-5">{{ post.commentaires | length }}</em></a></li>
                    <li><a><i class="fa fa-share-alt"></i></a></li>
                    <li><a><em class="mr-3">03</em></a></li>
                  </ul>
                  <ul>

                    {# /////////////////************************ like code **************** /////////////// #}
                    <a href="{{ path('post_like',{'id':post.id}) }}" class="btn btn-link js-like">

                      {% if app.user and post.isLikedByUser(app.user) %}
                        <i class="fa fa-thumbs-up"></i>
                      {% else %}
                        <i class="fa fa-thumbs-o-up"></i>
                      {% endif %}
                      <span class="js-likes">{{ post.likes | length }}</span>

                      <span class="js-label">j'aime</span>
                      {# /////////////////************************ like code **************** /////////////// #}
                    </a>

                    <li><a href="#"><img
                            src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/3.jpeg"
                            class="img-fluid rounded-circle" alt="User"></a></li>
                    <li><a href="#"><img
                            src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/1.jpg"
                            class="img-fluid rounded-circle" alt="User"></a></li>
                    <li><a href="#"><img
                            src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/5.jpg"
                            class="img-fluid rounded-circle" alt="User"></a></li>
                    <li><a href="#"><img
                            src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/2.jpg"
                            class="img-fluid rounded-circle" alt="User"></a></li>

                  </ul>
                </div>
                <!--/ cardbox-base -->
                <form name="form" method="get" id="{{ post.id }}" class="comment"
                      action="{{ path('newcomment',{'id':post.id}) }}">
                  <input type="text" placeholder="Ecrivez votre commentaire ici ..."
                         style="padding: 11px;width: 490px" name="aa" id="aa" class="texte">
                  <br>
                  <p id="m" style="font-size: small;margin-left: 10px"></p>
                </form>

                {#
                <span class="comment-avatar float-left">
                    <a class="btn btn-primary"
                           href="{{ path('comment_new',{"id":post.id}) }}"><i
                                    class="fa fa-edit"></i></a>



                           <img class="rounded-circle"
                                src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/6.jpg"
                                alt="...">{{ app.user }}</a>
                </span>


                                            <div class="search">
                                                <input placeholder="Write a comment" type="text">
                                                <button><i class="fa fa-camera"></i></button>
                                            </div>
                                            <!--/. Search -->  #}

                <!--/ cardbox-like -->


                {#    {% for comm in post.commentaires |slice (0) %} #}
                {% for comm in comments %}
                  {% if post.id is same as comm.post.id %}
                    <div style="background-color: #F8F9F9;padding: 3px;border-radius: 20px" id="add"
                         class="add">
                      <p>
                      <p id="part2" style="font-size: small">Ajouté par <span
                            style="font-weight: bold">{{ comm.user.firstName }}  </span>le {{ comm.createdAt|date('d/m/Y H:i') }}
                      </p>
                      <span>{{ comm.content }}</span>


                      {% if app.user == comm.user %}
                        <a href="{{ path('editcomment', {'id': comm.id}) }}">modifier</a>
                        <a href="{{ path('delete_commnt_user', {'id': comm.id}) }}">supprimer</a>

                      {% endif %}


                    </div>
                    <br>
                  {% endif %}
                {% endfor %}

              </div>
              <!--/ cardbox -->


            </div><!--/ col-lg-6 -->
            <div class="col-lg-3">
              <div class="shadow-lg p-4 mb-2 bg-white author">
                <a href="#">Contacter l'annonceur</a>
                <p>Numero de telephone: {{ post.user.phonenumber }} </p>
                <p>Email: {{ post.user.email }}</p>
              </div>
            </div><!--/ col-lg-3 -->

          </div><!--/ row -->
        </div><!--/ container -->
      </section>
    {% endif %}
  {% endfor %}



{% endblock %}


{% block page_script %}
  <!-- Page js files -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  {# bloc java script pour ajax #}
  <script>

      // fonction
      function onClickBtnLike(event) {
          event.preventDefault();

          // nheb na7i lien mte3 like bech ki nekliki meyodhherlich lien
          // this hiya l "a mte3 l href ili 9a3da nekliki aaliha "
          const url = this.href;
          const spanCount = this.querySelector('span.js-likes');

          // nbadel l'icone
          const icone = this.querySelector('i');
          axios.get(url).then(function (response) {
              //  console.log(response);
              debugger;
              spanCount.textContent = response.data.likess;
              // console.log(likess);

              if (icone.classList.contains('fa')) {
                  icone.classList.replace('fa', 'fas');

              } else {
                  icone.classList.replace('fas', 'fa');
              }

              // si il'ya une erreur
          }).catch(function (error) {
              if (error.response.status === 403) {
                  window.alert('pardon!! vous ne pouvez pas liker un article si vous n\'etes pas connecté! ');
              }
          })


      }

      //recupere tous les lien de "a" qui contiennent la classe js-like
      // forEach(function) ==> f kol a.js-like bch naamel fonction
      document.querySelectorAll('a.js-like').forEach(function (link) {
          link.addEventListener('click', onClickBtnLike)
      })


      function onClickBtnComment(event) {
          event.preventDefault();
          const url = this.action;
          console.log(url);
          var com = this.querySelector('.msg');
          var span = this.querySelector('.c1');
          var count = this.querySelector('.count');
          var texte = this.querySelector('.texte');

          var inputVal = document.getElementById("aa").value;

          let data = new FormData(this);
          axios.post(url, data).then(function (response) {
              // $('#count').load(document.URL +  ' #count');
              console.log(inputVal);
              //  console.log(response.data);
              count.textContent = response.data.nbrcomments;
              span.textContent = response.data.message;
            {% if app.user %}

              com.textContent = " Ajouté par {{ app.user.firstName |upper }} " + "  à " + "  " + response.data.dateajout;
            {% endif %}
              // $('#aa').value = "";
              // $('#msg').load(document.URL +  ' #msg');


              // document.getElementById("msg1").innerHTML="dddd";
          }).catch(function (error) {
              console.log(error)
          })
        {% if app.user %}
          document.getElementById("m").innerHTML = "Ajouté a l'instant  par {{ app.user.firstName |upper }} <br/>" + inputVal;
        {% endif %}
      }

      document.querySelectorAll('form.comment').forEach(function (link) {

          link.addEventListener('submit', onClickBtnComment)
      });

  </script>













{% endblock %}
